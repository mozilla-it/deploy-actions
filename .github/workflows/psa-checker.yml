# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# Reusable workflow to render helm charts and check if they meet PSS level restricted

name: render helm charts and check pod security level
on:
  workflow_call:
    inputs:
      pss_level:
        description: 'PSS level to check against'
        default: 'restricted'
        required: false
        type: string
env:
  HEAD_REF: ${{ github.head_ref }}
  PSA_CHECKER_IMAGE: 'us-west1-docker.pkg.dev/moz-fx-platform-artifacts/platform-shared-images/psa-checker'
  PSA_CHECKER_SHA: '567481c4bf3d981cef05a4fe021e5dfa0caa8378'

jobs:
  get_changed_helm_charts:
    runs-on: ubuntu-latest
    outputs:
      matrix_charts: ${{ steps.find_changed_charts.outputs.matrix_changed_charts }}
      charts: ${{ steps.find_changed_charts.outputs.changed_charts }}
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
         fetch-depth: '100'
         persist-credentials: true # We are using these credentials in later steps

      - name: find changed helm charts
        id: find_changed_charts
        run: |
          git fetch origin $GITHUB_BASE_REF:$GITHUB_BASE_REF
          echo matrix_changed_charts=$(git diff --name-only $GITHUB_BASE_REF...HEAD -- '**/k8s/**/*.yaml' '**/k8s/**/*.yml' '**/k8s/**/*.tpl' '**/k8s/**/*.tmpl' | cut -d'/' -f1,2,3 | uniq | jq -R 'split("\n")' | jq -s 'flatten(1)') >> $GITHUB_OUTPUT
          echo changed_charts=$(git diff --name-only $GITHUB_BASE_REF...HEAD -- '**/k8s/**/*.yaml' '**/k8s/**/*.yml' '**/k8s/**/*.tpl' '**/k8s/**/*.tmpl' | cut -d'/' -f1,2,3 | uniq) >> $GITHUB_OUTPUT
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}

  check_pod_security_level:
    runs-on: ubuntu-latest
    needs: get_changed_helm_charts
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.get_changed_helm_charts.outputs.matrix_charts) }}
    steps:
        # Download charts already rendered by validate action
      - name: download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "k8s-manifests-*"
          merge-multiple: true
          path: "shared"
      - name: run psa-checker
        id: psa_check
        env:
          PSS_LEVEL: ${{ inputs.pss_level }}
        run: |
          # Loop over each `values-*` dir and check PSS levels
          cd "shared/charts/${{ matrix.chart }}/"
          for ENV_DIR in "*/"; do
              cat "$ENV_DIR/*/*/*.yaml" | docker run -i "$PSA_CHECKER_IMAGE":"$PSA_CHECKER_SHA" --level "$PSS_LEVEL" -f -
          done
