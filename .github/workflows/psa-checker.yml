# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# Reusable workflow to render helm charts and check if they meet PSS level restricted

name: render and psa-check helm charts
on:
  workflow_call:
    inputs:
      pss_level:
        description: 'PSS level to check against'
        default: 'restricted'
        required: false
        type: string
      charts:
        description: 'List of charts to run psa-checker on'
        required: true
        type: string
env:
  HEAD_REF: ${{ github.head_ref }}
  PSA_CHECKER_IMAGE: 'us-west1-docker.pkg.dev/moz-fx-platform-artifacts/platform-shared-images/psa-checker:567481c4bf3d981cef05a4fe021e5dfa0caa8378'

jobs:
  check_pod_security_level:
    runs-on: ubuntu-latest
    steps:
      - name: download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "k8s-manifests-*"
          merge-multiple: true
          path: "shared"
      - name: run psa-checker
        id: diff_helm_charts
        run: |
          for chart in ${CHARTS}; do
              echo "$chart" | docker run -i "$PSA_CHECKER_IMAGE"  --level ${{ inputs.pss_level }} -f -
          done
        env:
          CHARTS: ${{ inputs.charts }}
