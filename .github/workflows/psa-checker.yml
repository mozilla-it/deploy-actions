# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# Reusable workflow to render helm charts and check if they meet PSS level restricted

name: render and psa-check helm charts
on:
  workflow_call:
    inputs:
      pss_level:
        description: 'PSS level to check against'
        default: 'restricted'
        required: false
        type: string

env:
  HEAD_REF: ${{ github.head_ref }}

jobs:
  check_pod_security_level:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.18.0'
      - run: go install github.com/mozilla/psa-checker@20becf1189cf776e45a2ea27ea329e2e01de381a
      - name: setup helm
        uses: azure/setup-helm@29960d0f5f19214b88e1d9ba750a9914ab0f1a2f #v4.0.0

      - name: download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "k8s-manifests-*"
          merge-multiple: true
          path: "shared"
      - name: run psa-checker
        id: diff_helm_charts
        run: |
          for chart in ${CHARTS}; do
              echo "$chart"
              echo "$CHARTS"
              echo "$chart" | psa-checker --level ${{ inputs.pss_level }}  -f -
          done
        env:
          CHARTS: ${{ needs.get_changed_helm_charts.outputs.charts }}
