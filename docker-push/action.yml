name: docker-push
description: Push a Docker image to GAR.

inputs:
  gar_location:
    description: GCP region where target GAR is located
    required: true
    default: us
  should_authenticate_to_ghcr:
    description: Whether or not to authenticate to Github Container Registry
    required: false
    default: "false"
  image_tags:
    description: Newline-delimited list of images to be pushed. Typically generated by mozilla-it/deploy-actions/build-image or docker/metadata-action.
    required: true
  workload_identity_pool_project_number:
    description: Project number of workload identity pool used for OIDC authentication.
    required: true
  project_id:
    description: GCP project_id used to construct the service account.
    required: true
  deployment_env:
    description: If set, create a GitHub deployment in the given environment.
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Authenticate to GCP
      id: gcp_auth
      uses: google-github-actions/auth@3a3c4c57d294ef65efaaee4ff17b22fa88dd3c69 #v1
      with:
        workload_identity_provider: "projects/${{ inputs.workload_identity_pool_project_number }}/locations/global/workloadIdentityPools/github-actions/providers/github-actions"
        service_account: "artifact-writer@${{ inputs.project_id }}.iam.gserviceaccount.com"
        token_format: access_token
        create_credentials_file: false
    - name: Log in to GAR
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 #v3
      with:
        registry: ${{ inputs.gar_location }}-docker.pkg.dev
        username: oauth2accesstoken
        password: "${{ steps.gcp_auth.outputs.access_token }}"
    - name: Log in to the GitHub Container registry
      if: inputs.should_authenticate_to_ghcr == 'true'
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}
    - name: Tag and push Docker image(s)
      shell: bash
      env:
        IMAGE_TAGS: ${{ inputs.image_tags }}
      run: |
        while IFS= read -r image_tag; do
            docker push $image_tag 
        done <<< "${IMAGE_TAGS}"
    - name: Create GitHub deployment
      if: inputs.deployment_env != ''
      run: |
        gh api "repos/${GITHUB_REPOSITORY}/deployments" \
            -f environment="${DEPLOYMENT_ENV}" \
            -f ref="${GITHUB_REF}" \
            -F auto_merge=false \
            -F required_contexts[] \
            -F payload[image_tag]="${IMAGE_TAG}"
      env:
        DEPLOYMENT_ENV: ${{ inputs.deployment_env }}
        GH_TOKEN: ${{ github.token }}
        GITHUB_REG: ${{ github.ref }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        IMAGE_TAG: ${{ inputs.image_tag }}
      shell: sh
